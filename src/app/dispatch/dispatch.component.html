<div class="dispatch-container">
  <!-- Header Section -->
  <header class="dispatch-header">
    <div class="header-content">
      <div class="logo-section">
        <div class="logo-icon">
          <i class="fas fa-truck"></i>
        </div>
        <h1>Dispatch Management</h1>
      </div>
      <div class="header-actions">
        <button class="btn-primary">
          <i class="fas fa-plus"></i>
          New Dispatch
        </button>
      </div>
    </div>
  </header>

  <!-- Stats Cards Section -->
  <section class="stats-section">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-boxes"></i>
        </div>
        <div class="stat-content">
          <h3>{{ SmoothieProduction.length }}</h3>
          <p>Available Items</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-truck-loading"></i>
        </div>
        <div class="stat-content">
          <h3>{{ dispatchList.length }}</h3>
          <p>Ready to Dispatch</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
          <h3>{{ driversList.length }}</h3>
          <p>Active Drivers</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stat-content">
          <h3>{{ preDispatchRecords.length }}</h3>
          <p>Pending Deliveries</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Content Section -->
  <section class="main-content">
    <div class="content-grid">
      <!-- Left Column: Inventory Table -->
      <div class="content-column">
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-inventory"></i> Inventory Items</h2>
            <div class="card-actions">
              <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Search items..." (input)="onSearch($any($event).target.value, dt)"
                  class="search-input" />
              </div>
              <div class="filter-controls">
                <p-selectButton [options]="periodOptions" [(ngModel)]="selectedPeriod"
                  (onChange)="setView(selectedPeriod)" class="period-selector"></p-selectButton>
                <button class="btn-secondary" (click)="dt.exportCSV()">
                  <i class="fas fa-download"></i>
                  Export
                </button>
              </div>
            </div>
          </div>

          <!-- Date Range Controls -->
          <div class="date-controls" *ngIf="selectedPeriod === 'date'">
            <p-datepicker [(ngModel)]="rangeDates" selectionMode="range" [showIcon]="true"
              placeholder="Select date range" class="date-picker"></p-datepicker>
          </div>

          <div class="date-controls" *ngIf="selectedPeriod === 'week'">
            <p-datepicker [(ngModel)]="selectedDate" [showIcon]="true" placeholder="Select week"
              class="date-picker"></p-datepicker>
          </div>

          <div class="date-controls" *ngIf="selectedPeriod === 'month'">
            <p-datepicker [(ngModel)]="selectedDate" view="month" dateFormat="MM yy" [showIcon]="true"
              placeholder="Select month" class="date-picker"></p-datepicker>
          </div>

          <div class="date-controls" *ngIf="selectedPeriod === 'year'">
            <p-datepicker [(ngModel)]="selectedDate" view="year" dateFormat="yy" [showIcon]="true"
              placeholder="Select year" class="date-picker"></p-datepicker>
          </div>

          <div class="table-container">
            <p-table #dt [value]="SmoothieProduction" [columns]="selectedColumns"
              [globalFilterFields]="globalFilterFields" [paginator]="true" [rows]="10"
              [rowsPerPageOptions]="[5,10,20,50]" [scrollable]="true" [resizableColumns]="true"
              columnResizeMode="expand" [exportHeader]="'customExportHeader'" selectionMode="multiple"
              currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries" [filterDelay]="0"
              [tableStyle]="{'min-width': '50rem'}" [responsiveLayout]="'scroll'" [breakpoint]="'600px'"
              stripedRows="true" rowHover="true" showCurrentPageReport="true" class="inventory-table">
              <ng-template pTemplate="header" let-columns>
                <tr>
                  <th class="table-header">ID</th>
                  <th *ngFor="let col of columns" [pSortableColumn]="col.field" class="table-header">
                    {{ col.header }} <p-sortIcon [field]="col.field"></p-sortIcon>
                  </th>
                  <th class="table-header">Actions</th>
                </tr>
              </ng-template>

              <ng-template pTemplate="body" let-row let-columns="columns" let-i="rowIndex">
                <tr [ngClass]="{ 'highlight-row': rowMatchesSearch(row, columns) }" class="table-row">
                  <td class="table-cell">{{ i + 1 }}</td>
                  <td *ngFor="let col of columns" class="table-cell">
                    <ng-container [ngSwitch]="col.type">
                      <span *ngSwitchCase="'shortDate'">{{ row[col.field] | date:'short' }}</span>
                      <span *ngSwitchCase="'date'">{{ row[col.field] | date }}</span>
                      <span *ngSwitchDefault [innerHTML]="highlightSearchText(row[col.field])"></span>
                    </ng-container>
                  </td>
                  <td class="table-cell actions-cell">
                    <div class="action-inputs">
                      <div class="input-group">
                        <label>Qty:</label>
                        <input type="number" [(ngModel)]="row.transferQty" min="0" [max]="row.cotton"
                          class="quantity-input" placeholder="0" />
                      </div>
                      <div class="input-group">
                        <label>Location:</label>
                        <input type="text" [(ngModel)]="row.location" placeholder="Enter location"
                          class="location-input" />
                      </div>
                      <button class="btn-success" (click)="addToDispatchList(row)"
                        [disabled]="!row.transferQty || !row.location">
                        <i class="fas fa-plus"></i>
                        Add
                      </button>
                    </div>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </div>
      </div>

      <!-- Right Column: Dispatch Management -->
      <div class="content-column">
        <!-- Driver Information -->
        <div class="card">
          <div class="card-header">
            <h2><i class="fas fa-users"></i> Driver Information</h2>
          </div>
          <div class="driver-grid">
            <div class="driver-card" *ngFor="let driver of driversList">
              <div class="driver-avatar">
                <i class="fas fa-user"></i>
              </div>
              <div class="driver-info">
                <h4>{{ driver.driver_name }}</h4>
                <p class="driver-id">ID: {{ driver.driver_id }}</p>
                <p class="truck-info">
                  <i class="fas fa-truck"></i>
                  {{ driver.truck_no }}
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Dispatch Ready Items -->
        <div class="card" *ngIf="dispatchList.length > 0">
          <div class="card-header">
            <h2><i class="fas fa-check-circle"></i> Ready to Dispatch</h2>
            <span class="badge">{{ dispatchList.length }} items</span>
          </div>
          <div class="dispatch-items">
            <div class="dispatch-item" *ngFor="let item of dispatchList; let i = index">
              <div class="item-info">
                <h4>{{ item.smoothie_name }}</h4>
                <p>Qty: {{ item.transferQty }} | Location: {{ item.location }}</p>
              </div>
              <button class="btn-danger" (click)="removeRow(i)">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>

          <div class="dispatch-form">
            <div class="form-group">
              <label for="driverName">Select Driver:</label>
              <p-autoComplete [(ngModel)]="driverName" [suggestions]="filteredDriverNames"
                (completeMethod)="filterDriverNames($event)" placeholder="Search driver..."
                class="driver-autocomplete"></p-autoComplete>
            </div>
            <button class="btn-primary btn-full" (click)="preDispatch()"
              [disabled]="!driverName || dispatchList.length === 0">
              <i class="fas fa-paper-plane"></i>
              Dispatch All Items
            </button>
          </div>
        </div>

        <!-- Pending Deliveries -->
        <div class="card" *ngIf="preDispatchRecords.length > 0">
          <div class="card-header">
            <h2><i class="fas fa-clock"></i> Pending Deliveries</h2>
          </div>
          <div class="pending-deliveries">
            <div class="delivery-item" *ngFor="let dispatch of preDispatchRecords">
              <div class="delivery-header">
                <h4>{{ dispatch.driver_name }}</h4>
                <span class="status-badge status-{{ dispatch.status.toLowerCase() }}">
                  {{ dispatch.status }}
                </span>
              </div>
              <p class="delivery-date">
                <i class="fas fa-calendar"></i>
                {{ dispatch.dispatch_date | date:'medium' }}
              </p>

              <div class="delivery-items">
                <div class="delivery-item-row" *ngFor="let item of dispatch.items">
                  <div class="item-details">
                    <span class="item-name">{{ item.smoothie_name }}</span>
                    <span class="item-qty">Qty: {{ item.transfer_qty }}</span>
                    <span class="item-location">{{ item.location }}</span>
                  </div>
                  <div class="returns-input">
                    <label>Returns:</label>
                    <input type="number" [(ngModel)]="item.returns" min="0" [max]="item.transfer_qty" placeholder="0"
                      class="returns-field" />
                  </div>
                </div>
              </div>

              <button class="btn-success btn-full" (click)="completePreDispatch(dispatch)">
                <i class="fas fa-check"></i>
                Complete Delivery
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Toast Messages -->
  <p-toast></p-toast>
</div>